#' Install system dependencies that Rtools (and in turn packrat) require to build packages with compiled code on Windows
#'
#' This function install windows system dependencies that are required for building packages with compiled code. In particular it installs the local323.zip and curl-7.40.0.zip from the R tools goodies section of cran: https://www.stats.ox.ac.uk/pub/Rtools/goodies/multilib/ and makes them available to Rtools. \cr \cr
#'
#' The function extracts the zips to a folder (default is c:/extsoft) and creates a makevars file that points rtools to the packages. The default location of this is ~/.R./makevars. Usually ~ is My Documents. \cr
#'
#' Without this setup you will find that packages such as XML, stringi, RCurl will throw errors when compiling (usually when restoring old versions with packrat).
#'
#' @param extsoft_dir The directory you would like the external software to be installed in
#' @return Updated folder structure
#' @keywords environment, setup
#' @export
#' @examples
#' \dontrun{
#' setup_rtools_pkgs()
#' }

setup_rtools_pkgs <- function(extsoft_dir = 'c:/extsoft'){

  if (!(Sys.info()["sysname"] == "Windows")) {

    message("Windows only function. On Mac/Linux use respctive package managers.")

  } else {

    # Create temp directory
    temp_dir <- tempdir()

    # Download the local323 zip of system dependencies
    download.file('https://www.stats.ox.ac.uk/pub/Rtools/goodies/multilib/local323.zip', paste0(temp_dir,'/local323.zip'))

    # Download curl specific zip that is not captured in local323
    download.file('https://www.stats.ox.ac.uk/pub/Rtools/goodies/multilib/curl-7.40.0.zip', paste0(temp_dir,'/curl-7.40.0.zip'))

    # Download nlopt
    download.file('https://github.com/rwinlib/nlopt/archive/v2.4.2.zip', paste0(temp_dir,'/nlopt.zip'))

    # Download GTK
    download.file('http://ftp.gnome.org/pub/gnome/binaries/win32/gtk+/2.22/gtk+-bundle_2.22.1-20101227_win32.zip', paste0(temp_dir,'/gtk32.zip'))
    download.file('http://ftp.gnome.org/pub/gnome/binaries/win64/gtk+/2.22/gtk+-bundle_2.22.1-20101229_win64.zip', paste0(temp_dir,'/gtk64.zip'))

    # Check if c:/extsoft exists otherwise make it
    if (!dir.exists(extsoft_dir)) dir.create(extsoft_dir)

    # Unzip both of the zips into the directory
    unzip(paste0(temp_dir,'/local323.zip'), exdir = extsoft_dir)
    unzip(paste0(temp_dir,'/curl-7.40.0.zip'), exdir = extsoft_dir)
    unzip(paste0(temp_dir,'/nlopt.zip'), exdir = extsoft_dir)

    #Copy nlopt sub folder to root
    file.copy(paste0(extsoft_dir, "/nlopt-2.4.2/include"), extsoft_dir, recursive = TRUE)
    file.copy(paste0(extsoft_dir, "/nlopt-2.4.2/lib"), extsoft_dir, recursive = TRUE)

    # Delete redundant directory
    unlink(paste0(extsoft_dir, "/nlopt-2.4.2"), recursive = TRUE)

    # Create gtk folder
    if (!dir.exists(paste0(extsoft_dir, "/gtk"))) dir.create(paste0(extsoft_dir, "/gtk"))
    if (!dir.exists(paste0(extsoft_dir, "/gtk/i386"))) dir.create(paste0(extsoft_dir, "/gtk/i386"))
    if (!dir.exists(paste0(extsoft_dir, "/gtk/x64"))) dir.create(paste0(extsoft_dir, "/gtk/x64"))

    # Extract gtk
    unzip(paste0(temp_dir,'/gtk32.zip'),exdir =  paste0(extsoft_dir, "/gtk/i386"))
    unzip(paste0(temp_dir,'/gtk64.zip'),exdir =  paste0(extsoft_dir, "/gtk/x64"))

    # Check if ~/.R directory exists (this is folder where custom makevars go)
    if (!dir.exists('~/.R')) dir.create('~/.R')

    # Define custom makevars file
    makevars <- c(
      paste0('LOCAL_SOFT = ', extsoft_dir),
      paste0('LIB_XML = ', extsoft_dir),
      paste0('GTK_PATH = ', extsoft_dir, '/gtk$(R_ARCH)'),
      'ifneq ($(strip $(LOCAL_SOFT)),)',
      'LOCAL_CPPFLAGS = -I"$(LOCAL_SOFT)/include"',
      'LOCAL_LIBS = -L"$(RWINLIB)/lib$(R_ARCH)" -L"$(LOCAL_SOFT)/lib$(R_ARCH)" -L"$(LOCAL_SOFT)/lib"',
      'endif'
    )

    # Write makevars file to default user makevars location
    writeLines(makevars, '~/.R./makevars')

    # Custom rprofile
    rprofile <- c(
      paste0('Sys.setenv(PATH = paste(paste0("', extsoft_dir, '/gtk", Sys.getenv("R_ARCH"), "/bin"), Sys.getenv("PATH"), sep=";"))'),
      'Sys.setenv(PATH = paste("C:/Rtools/usr/bin", Sys.getenv("PATH"), sep=";"))',
      'Sys.setenv(BINPREF = "C:/Rtools/mingw_$(WIN)/bin/")'
    )

    # Write custom rprofile
    writeLines(rprofile, '~/.Rprofile')


    # Return success
    message('Rtools external packages succesffully installed!')
  }

}

